(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[153],{1550:function(e,t,n){"use strict";n.r(t),n.d(t,{__N_SSG:function(){return M},default:function(){return z}});var r=n(7812),c=n(9499),o=n(29),a=n(7794),i=n.n(a),s=n(7294),u=n(1270),l=n.n(u),d=n(5835),f=n(7642),p=n(4730),_=n(9922),m=n(3806),v=n(3143),h=n.n(v),w=n(8924),b=n.n(w),g=n(9980),x=n.n(g),y=n(5893),j=["isCanSubmit","onSubmit","placeholder"];function O(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function k(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?O(Object(n),!0).forEach(function(t){(0,c.Z)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):O(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}var I=(0,s.forwardRef)(function(e,t){var n=e.isCanSubmit,r=void 0===n||n,c=e.onSubmit,o=e.placeholder,a=(0,p.Z)(e,j),i=new(x()),u=(0,s.useRef)(null),l=(0,s.useRef)(null),d=(0,s.useState)(!1),f=d[0],v=d[1],w=(0,s.useRef)(null),g=(0,s.useState)(!1),O=g[0],I=g[1],S=function(){if(null!==(e=l.current)&&void 0!==e&&e.value){var e,t=b()(i.render(l.current.value));(null==w?void 0:w.current)&&(w.current.innerHTML=t)}};return(0,s.useImperativeHandle)(t,function(){return{insertContent:function(e){l.current&&(l.current.value+=e)}}}),(0,y.jsxs)(y.Fragment,{children:[(0,y.jsxs)(_.Z,k(k({ref:u,clickable:!1,className:h().my_textarea_wrap},a),{},{autoUpload:!0,operateLineStyle:f?{marginTop:"0"}:{},onFinish:function(e){console.log(e),setTimeout(function(){l.current&&(l.current.value=l.current.value+e.map(function(e){var t=e.normal;return"\n![".concat(t.name,"](https://wsrv.nl/?url=").concat(t.download_url.replace("https://",""),")")}).join("\n"),l.current.focus())})},children:[(0,y.jsxs)("div",{children:[(0,y.jsx)("label",{htmlFor:"commentInput"}),(0,y.jsx)("textarea",{id:"commentInput",ref:l,className:h().text_area,rows:8,style:{display:f?"none":"block"},placeholder:void 0===o?"请输入, 支持markdown语法......":o,suppressContentEditableWarning:!0,contentEditable:!0,onPaste:function(e){var t,n=[],r=e.clipboardData.items;if(r&&r.length){for(var c=0;c<r.length;c++)if(-1!==r[c].type.indexOf("image")){var o=r[c].getAsFile();o&&n.push(o)}}n&&(null===(t=u.current)||void 0===t||t.addFile(n))},onInput:function(){var e;I(!(!r||!(null!==(e=l.current)&&void 0!==e&&e.value)))}})]}),(0,y.jsxs)("div",{className:h().operate_wrap,children:[(0,y.jsx)(m.Z,{type:"code",className:h().preview,alt:"preview",onClick:function(e){e.stopPropagation(),v(function(e){return e||S(),!e})}}),(0,y.jsx)("button",{className:h().submit,disabled:!O,"aria-label":"submit comment",onClick:function(e){var t;e.stopPropagation(),c({content:null===(t=l.current)||void 0===t?void 0:t.value}),l.current&&(l.current.value="")},children:"add comment"})]})]})),(0,y.jsx)("div",{className:h().preview_detail_wrap,style:{display:f?"block":"none"},children:(0,y.jsx)("div",{ref:w,className:"".concat(h().blog_content," ").concat(h().preview_detail)})})]})}),S=n(8984),N=n(277),C=["className","text"];function P(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function D(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?P(Object(n),!0).forEach(function(t){(0,c.Z)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):P(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}var E=function(e){var t=e.className,n=e.text,r=(0,p.Z)(e,C),c=new(x());return(0,y.jsx)("div",D(D({className:"md_detail ".concat(t)},r),{},{dangerouslySetInnerHTML:{__html:(0,N.K)(b()(c.render(n||"")))}}))},T=n(2568),R=n.n(T);function Z(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function L(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Z(Object(n),!0).forEach(function(t){(0,c.Z)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Z(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}var M=!0;function z(){var e,t=(0,s.useState)("https://raw.githubusercontent.com/mirrows/photo/main/normal/2024_10_28/pic1730078673558002.jpg")[0],n=(0,s.useRef)(0),c=(0,s.useRef)(""),a=(0,s.useState)([]),u=a[0],p=a[1],_=(0,s.useRef)([]),v=(0,s.useState)(!1),h=(v[0],v[1]),w=(0,s.useRef)(null),b=(0,s.useRef)(""),g=(0,s.useState)({roomId:"",userName:"",socketId:"",dc:null,pc:null,alive:!1}),x=g[0],j=g[1],O=(0,s.useRef)({roomId:"",userName:"",socketId:"",dc:null,pc:null,alive:!1}),k=(0,s.useState)(!1),N=k[0],C=k[1],P=(0,s.useState)(!1),D=P[0],T=P[1],Z=(0,s.useState)([]),M=Z[0],z=Z[1],J=(e=(0,o.Z)(i().mark(function e(){var t,n,r,c,o,a,s;return i().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!(r=localStorage.info)){e.next=13;break}return e.prev=2,(c=JSON.parse(r)).socketId="",j(c),O.current=c,e.abrupt("return");case 10:e.prev=10,e.t0=e.catch(2),console.log("fail to parse info",r);case 13:return e.next=15,(0,d.oQ)();case 15:s={roomId:"",userName:(a=(null==(o=e.sent)?void 0:null===(t=o.results)||void 0===t?void 0:null===(n=t[0])||void 0===n?void 0:n.name)||"")?"".concat(a.first," ").concat(a.last):String(Math.random()).slice(4,8),socketId:"",dc:null,pc:null,alive:!1},O.current=s,j(s),localStorage.setItem("info",JSON.stringify(s));case 21:case"end":return e.stop()}},e,null,[[2,10]])})),function(){return e.apply(this,arguments)}),F=function(e){console.log(e,_.current);var t={id:S.Tw.get("".concat(b.current).concat(O.current.socketId)),type:"text",content:e,from:O.current,time:new Date().toLocaleString()};z(function(e){return e.concat(t)}),_.current.forEach(function(e){var n;null===(n=e.dc)||void 0===n||n.send(JSON.stringify(t))})},W=function(){var e;O.current.userName&&(O.current.alive=!0,O.current.roomId="",localStorage.setItem("info",JSON.stringify(O.current)),O.current.roomId=R()(c.current)||"",null===(e=w.current)||void 0===e||e.emit("join",{info:O.current}))},q=function(){var e;console.log("leave room"),O.current.alive=!1,_.current.forEach(function(e){var t;null===(t=e.dc)||void 0===t||t.send(JSON.stringify({id:S.Tw.get("".concat(b.current).concat(O.current.socketId)),type:"tips",content:"用户".concat(O.current.userName,"离开房间"),from:O.current,time:new Date().toLocaleString()}))}),null===(e=w.current)||void 0===e||e.emit("leave",O.current)};function A(){return(A=(0,o.Z)(i().mark(function e(){return i().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:_.current.forEach(function(){var e=(0,o.Z)(i().mark(function e(t){var n,r,c,o;return i().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("requestVideoCall"),e.next=3,null===(n=t.pc)||void 0===n?void 0:n.createOffer();case 3:return o=e.sent,e.next=6,null===(r=t.pc)||void 0===r?void 0:r.setLocalDescription(o);case 6:null===(c=w.current)||void 0===c||c.emit("offer",{offer:o,info:O.current,to:t});case 7:case"end":return e.stop()}},e)}));return function(t){return e.apply(this,arguments)}}());case 1:case"end":return e.stop()}},e)}))).apply(this,arguments)}var X=function(){var e,t,n;w.current=(0,f.io)(S.OB.extraUrl,{transports:["websocket"],withCredentials:!0}),w.current.on("connected",function(e){console.log("new ID:",e),h(!0),O.current.socketId=e,j(O.current),W()}),w.current.on("join",function(e){var t=e.user,n=e.another;if(404===e.result){console.warn("该房间不存在或已销毁，请检查房间号");return}var r=_.current.reduce(function(e,t){return e[t.socketId]=t,e},{}),c=n.filter(function(e){return e.socketId!==O.current.socketId}).map(function(e){return r[e.socketId]||e});p(c),_.current=c,t.socketId!==O.current.socketId?(z(function(e){return e.concat({id:S.Tw.get("".concat(b.current).concat(O.current.socketId)),type:"tips",content:"用户".concat(t.userName,"加入房间"),from:t,time:new Date().toLocaleString()})}),Y(t)):(z(function(e){return e.concat({id:S.Tw.get("".concat(b.current).concat(O.current.socketId)),type:"tips",content:"你已加入房间",from:t,time:new Date().toLocaleString()})}),C(!0),_.current.forEach(function(e){Y(e,!0)})),t.socketId===O.current.socketId&&c.length>0&&function(){A.apply(this,arguments)}()}),w.current.on("receive_offer",(e=(0,o.Z)(i().mark(function e(t){var n,r,c,o,a,s,u;return i().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(c=t.info,o=t.to,a=t.offer,console.log("receive offer"),null!=(s=_.current.find(function(e){return e.socketId===c.socketId}))&&s.pc){e.next=5;break}return e.abrupt("return");case 5:return e.next=7,s.pc.setRemoteDescription(a);case 7:return e.next=9,null===(n=s.pc)||void 0===n?void 0:n.createAnswer();case 9:return u=e.sent,e.next=12,s.pc.setLocalDescription(u);case 12:null===(r=w.current)||void 0===r||r.emit("answer",{answer:u,info:o,to:c});case 13:case"end":return e.stop()}},e)})),function(t){return e.apply(this,arguments)})),w.current.on("receive_answer",(t=(0,o.Z)(i().mark(function e(t){var n,r,c,o;return i().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.info,c=t.answer,console.log("receive answer"),null!=(o=_.current.find(function(e){return e.socketId===r.socketId}))&&o.pc){e.next=5;break}return e.abrupt("return");case 5:return e.next=7,null===(n=o.pc)||void 0===n?void 0:n.setRemoteDescription(c);case 7:case"end":return e.stop()}},e)})),function(e){return t.apply(this,arguments)})),w.current.on("add_candidate",(n=(0,o.Z)(i().mark(function e(t){var n,r,c,o;return i().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.info,c=t.candidate,console.log("add_candidate"),null!=(o=_.current.find(function(e){return e.socketId===r.socketId}))&&o.pc){e.next=5;break}return e.abrupt("return");case 5:null===(n=o.pc)||void 0===n||n.addIceCandidate(c);case 6:case"end":return e.stop()}},e)})),function(e){return n.apply(this,arguments)}))};function Y(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=_.current.find(function(t){return t.socketId===e.socketId});n&&(null!=n&&n.pc||(n.pc=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun.miwifi.com"},{urls:"stun:stun.voipbuster.com"},{urls:"stun:stun.qq.com"},{urls:"turn:stun.t-n.top:3478",username:"test12138",credential:"test12138"}]})),t?(n.dc=n.pc.createDataChannel("my channel"),console.log("new datachannel"),G(n.dc)):(console.log("ready to datachannel"),n.pc.ondatachannel=function(e){console.log("on datachannel"),n.dc=e.channel,n.dc.onopen=function(){console.log("Data channel is open!")},G(n.dc)}),n.pc.onicecandidate=function(e){var t,n,r=null===(t=e.candidate)||void 0===t?void 0:null===(n=t.candidate)||void 0===n?void 0:n.match(/([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/);r&&(b.current=r[0]),_.current.forEach(function(t){var n;null===(n=w.current)||void 0===n||n.emit("add_candidate",{candidate:e.candidate,info:O.current,to:t})})},n.pc.oniceconnectionstatechange=function(){var e,t,r,c;null===(e=n.pc)||void 0===e||e.iceConnectionState,((null===(t=n.pc)||void 0===t?void 0:t.iceConnectionState)==="disconnected"||(null===(r=n.pc)||void 0===r?void 0:r.iceConnectionState)==="failed")&&console.warn("连接失败，请重新连接"),console.log("oniceconnectionstatechange: ".concat(null===(c=n.pc)||void 0===c?void 0:c.iceConnectionState))})}var G=function(e){e.onmessage=function(e){console.log("received msg: "+e.data);try{var t=JSON.parse(e.data);t.from&&(_.current=_.current.map(function(e){return e.socketId===t.from.socketId?L(L({},e),t.from):e}),p((0,r.Z)(_.current))),z(function(e){return e.concat(t)})}catch(t){console.log("fail to parse msg",e.data)}}};return(0,s.useEffect)(function(){return S.SR.on("ip",function(e){var t=e.detail;console.log(t),c.current=null==t?void 0:t.ip,J().then(function(){n.current,n.current>0?n.current-=1:X()})}),window.addEventListener("beforeunload",q),function(){var e,t;q(),n.current+=1,null===(e=w.current)||void 0===e||e.disconnect(),null===(t=w.current)||void 0===t||t.off(),w.current=null,window.removeEventListener("beforeunload",q)}},[]),(0,y.jsx)(y.Fragment,{children:(0,y.jsx)("div",{className:l().chat_wrap,style:{backgroundImage:"url('".concat(t,"')")},children:(0,y.jsxs)("div",{className:l().layout_wrap,children:[(0,y.jsxs)("div",{className:l().main_container,children:[(0,y.jsxs)("div",{className:l().header_line,children:[(0,y.jsx)("div",{className:"".concat(l().join_status_ball," ").concat(l()[N?"ball_joined":"ball_wait"])}),(0,y.jsx)("div",{children:x.userName}),(0,y.jsx)(m.Z,{type:"chat_1",className:l().expand_icon,onClick:function(){return T(function(e){return!e})}})]}),(0,y.jsxs)("div",{className:"".concat(l().contents," scroll_er"),children:[N||(0,y.jsx)("div",{className:l().wait_tips,children:(0,y.jsx)("span",{className:l().wait_tip_txt,children:"正在链接 ... ..."})}),(0,y.jsx)("div",{children:M.map(function(e){return(0,y.jsx)("div",{children:{tips:(0,y.jsx)("div",{className:l().record_tips,children:(0,y.jsx)("div",{className:l().record_content,children:e.content})}),text:(0,y.jsxs)("div",{className:"".concat(l().record_text," ").concat(e.from.socketId===x.socketId?l().owner:""),children:[(0,y.jsx)("div",{className:l().user_name,children:e.from.userName}),(0,y.jsx)(E,{text:e.content,className:l().user_content})]}),file:(0,y.jsx)("div",{className:l().record_file,children:(0,y.jsx)("div",{className:l().record_content,children:e.content})})}[e.type]},e.id)})})]}),(0,y.jsx)("div",{children:(0,y.jsx)(I,{disabled:!N,style:{height:"unset"},onSubmit:function(e){return F(e.content||"")}})})]}),(0,y.jsx)("div",{className:"".concat(l().user_list," scroll_er"),style:{display:D?"block":"none"},children:u.map(function(e){return(0,y.jsxs)("div",{children:[(0,y.jsx)("div",{className:"".concat(l().join_status_ball," ").concat(l()[e.alive?"ball_joined":"ball_wait"])}),e.userName]},e.socketId)})})]})})})}},277:function(e,t,n){"use strict";n.d(t,{K:function(){return c},S:function(){return o}});var r={lazyImg:function(e){return e.replace(/\<img src/g,'<img class="lazy" src="'.concat("https://wsrv.nl/?url=raw.githubusercontent.com/mirrows/photo/main/normal/2023_09_10/pic1694333133502339.gif&w=130&fit=cover&n=-1&q=80",'" data-src'))},tableScroll:function(e){return e.replace(/\<table\>/g,'<div class="scroll_table"><table>').replace(/\<\/table\>/g,"</table></div>")}},c=function(e,t){var n={};null==t||t.forEach(function(e){n[e]=!0});var c=e;return Object.keys(r).forEach(function(e){n[e]||(c=r[e](c))}),c},o=function(e){return e.replace(/\*\*(.+)\*\*(\S)/g,"**$1** $2")}},5083:function(e,t,n){(window.__NEXT_P=window.__NEXT_P||[]).push(["/demos/miniChat",function(){return n(1550)}])},3143:function(e){e.exports={text_area:"MyTextarea_text_area__LOzbr",my_textarea_wrap:"MyTextarea_my_textarea_wrap__aZGa3",operate_wrap:"MyTextarea_operate_wrap__JRo7_",preview:"MyTextarea_preview__JYqBt",submit:"MyTextarea_submit__ykEIz",blog_content:"MyTextarea_blog_content__DkWlw",preview_detail:"MyTextarea_preview_detail__Dp34Q",preview_detail_wrap:"MyTextarea_preview_detail_wrap__fOhia",comment_detail:"MyTextarea_comment_detail__ZyhbX"}},1270:function(e){e.exports={chat_wrap:"miniChat_chat_wrap__FKgzw",join_status_ball:"miniChat_join_status_ball__XssW6",ball_joined:"miniChat_ball_joined__Cv_5R",ball_wait:"miniChat_ball_wait__8y0mc",ballRotate:"miniChat_ballRotate__TCf7_",layout_wrap:"miniChat_layout_wrap__yhWSG",main_container:"miniChat_main_container__odUrP",user_list:"miniChat_user_list__u98_d",contents:"miniChat_contents__6drSv",wait_tips:"miniChat_wait_tips__0dCMA",wait_tip_txt:"miniChat_wait_tip_txt__Eddez",typingWords:"miniChat_typingWords__p2MAi",cursor:"miniChat_cursor__xiLy8",record_tips:"miniChat_record_tips___YOZY",record_text:"miniChat_record_text__PIvzx",user_name:"miniChat_user_name__EpQhz",user_content:"miniChat_user_content__0SI3k",owner:"miniChat_owner__YPrIL",header_line:"miniChat_header_line__29TAx",expand_icon:"miniChat_expand_icon__itedh"}}},function(e){e.O(0,[880,811,642,922,774,888,179],function(){return e(e.s=5083)}),_N_E=e.O()}]);