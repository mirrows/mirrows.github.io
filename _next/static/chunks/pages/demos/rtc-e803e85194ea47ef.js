(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[826],{1721:function(e,r,t){"use strict";t.r(r),t.d(r,{__N_SSG:function(){return g},default:function(){return w}});var n,c=t(9499),o=t(29),a=t(7794),u=t.n(a),i=t(7294),s=t(5494),l=t.n(s),d=t(3806),f=t(5835),_=t(7642),p=t(1575),v=t(5893);function m(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable})),t.push.apply(t,n)}return t}function h(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?m(Object(t),!0).forEach(function(r){(0,c.Z)(e,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):m(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})}return e}p.jU&&(n=t(1415));var g=!0;function w(){var e,r=(0,i.useState)(0),t=r[0],c=r[1],a=(0,i.useState)(!1),s=a[0],m=a[1],g=(0,i.useState)(!1),w=g[0],b=g[1],x=(0,i.useState)({roomId:"",userName:"",socketId:""}),k=x[0],j=x[1],I=(0,i.useState)(!1),N=I[0],y=I[1],S=(0,i.useRef)(""),O=(0,i.useState)({roomId:"",userName:"",socketId:""}),P=O[0],C=O[1],E=(0,i.useRef)({roomId:"",userName:"",socketId:""}),R=(0,i.useRef)(null),Z=(0,i.useRef)(null),D=(0,i.useRef)(null),F=(0,i.useRef)(null),L=(0,i.useRef)(null),T=(0,i.useState)(!1),U=T[0],q=T[1],B=(e=(0,o.Z)(u().mark(function e(){var r,t,n,c,o,a,i;return u().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!(n=localStorage.info)){e.next=14;break}return e.prev=2,(c=JSON.parse(n)).socketId="",S.current&&(c.roomId=S.current),j(c),E.current=c,e.abrupt("return");case 11:e.prev=11,e.t0=e.catch(2),console.log("fail to parse info",n);case 14:return e.next=16,(0,f.oQ)();case 16:a=(null==(o=e.sent)?void 0:null===(r=o.results)||void 0===r?void 0:null===(t=r[0])||void 0===t?void 0:t.name)||"",i={roomId:String(Math.random()).slice(4,8),userName:a?"".concat(a.first," ").concat(a.last):String(Math.random()).slice(4,8),socketId:""},S.current&&(i.roomId=S.current),E.current=i,j(i),localStorage.setItem("info",JSON.stringify(n));case 23:case"end":return e.stop()}},e,null,[[2,11]])})),function(){return e.apply(this,arguments)}),J=function(){var e;E.current.roomId&&E.current.userName&&(localStorage.setItem("info",JSON.stringify(E.current)),null===(e=R.current)||void 0===e||e.emit("create_or_join_room",{info:E.current,roomId:S.current}))},M=function(){if(console.log("leave room"),j(function(e){var r;return null===(r=R.current)||void 0===r||r.emit("room_leave",e),e}),b(!1),y(!1),C({roomId:"",userName:"",socketId:""}),S.current="",null!=D&&D.current){var e,r=null===(e=D.current)||void 0===e?void 0:e.getTracks();null==r||r.forEach(function(e){e.stop()}),D.current=null,F.current&&(F.current.srcObject=null)}Z.current=null,L.current&&(L.current.srcObject=null),c(0),q(!1)};function z(){b(!0),j(function(e){var r;return console.log(E.current,e),null===(r=R.current)||void 0===r||r.emit("request_video",e),e})}var G=function(){var e,r,t,n;console.log("init spcket"),R.current=(0,_.io)("wss://use.t-n.top",{transports:["websocket"],withCredentials:!0}),R.current.on("connected",function(e){console.log("new ID:",e),m(!0),E.current=h(h({},E.current),{},{socketId:e}),j(E.current),S.current&&J()}),R.current.on("room_full",function(){return alert("房间已满，请更换房间号ID")}),R.current.on("room_created",function(e){alert("您已创建并加入【".concat(e.roomId,"】房间")),j(e),c(1)}),R.current.on("room_joined",function(e){var r=e.user,t=e.another,n=e.result;if(404===n){alert("该房间不存在或已销毁，请检查房间号"),c(0),S.current="",y(!1);return}c(2),C(r.socketId!==E.current.socketId?r:t),r.socketId!==E.current.socketId&&alert("用户".concat(r.userName,"加入【").concat(r.roomId,"】房间")),n&&y(!0),console.log(r,E.current,S.current),r.socketId===E.current.socketId&&S.current&&z()}),R.current.on("room_leave",function(e){e.socketId!==E.current.socketId?(C({roomId:"",userName:"",socketId:""}),alert("用户".concat(e.userName,"已离开【").concat(e.roomId,"】房间")),c(0),M()):c(0)}),R.current.on("receive_video",function(e){var r;e.socketId!==E.current.socketId&&window.confirm("您要接受用户".concat(e.userName,"的视频电话邀请吗？"))&&(null===(r=R.current)||void 0===r||r.emit("accept_video",E.current))}),R.current.on("accept_video",(e=(0,o.Z)(u().mark(function e(r){var t,n,c,o;return u().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return b(!0),e.next=3,function(){return A.apply(this,arguments)}();case 3:if(function(){var e;Z.current||(Z.current=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"turn:stun.t-n.top:3478",username:"test12138",credential:"test12138"}]})),Z.current.onicecandidate=function(e){var r;return null===(r=R.current)||void 0===r?void 0:r.emit("add_candidate",{candidate:e.candidate,info:E.current})},Z.current.oniceconnectionstatechange=function(){var e,r,t,n;(null===(e=Z.current)||void 0===e?void 0:e.iceConnectionState)==="connected"&&b(!1),((null===(r=Z.current)||void 0===r?void 0:r.iceConnectionState)==="disconnected"||(null===(t=Z.current)||void 0===t?void 0:t.iceConnectionState)==="failed")&&(b(!1),alert("连接失败，请重新连接"),M()),console.log("oniceconnectionstatechange: ".concat(null===(n=Z.current)||void 0===n?void 0:n.iceConnectionState))},Z.current.onsignalingstatechange=function(){var e;console.log("onsignalingstatechange: ".concat(null===(e=Z.current)||void 0===e?void 0:e.signalingState))},Z.current.ontrack=function(e){return L.current?L.current.srcObject=e.streams[0]:""},Z.current.onicegatheringstatechange=function(){var e;console.log("onicegatheringstatechange: ".concat(null===(e=Z.current)||void 0===e?void 0:e.iceGatheringState))},null===(e=D.current)||void 0===e||e.getTracks().forEach(function(e){if(D.current){var r;null===(r=Z.current)||void 0===r||r.addTrack(e,D.current)}})}(),!(r.socketId!==E.current.socketId)){e.next=11;break}return e.next=7,null===(t=Z.current)||void 0===t?void 0:t.createOffer();case 7:return o=e.sent,e.next=10,null===(n=Z.current)||void 0===n?void 0:n.setLocalDescription(o);case 10:null===(c=R.current)||void 0===c||c.emit("offer",{offer:o,info:E.current});case 11:case"end":return e.stop()}},e)})),function(r){return e.apply(this,arguments)})),R.current.on("receive_offer",(r=(0,o.Z)(u().mark(function e(r){var t,n,c;return u().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(Z.current){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,Z.current.setRemoteDescription(r);case 4:return e.next=6,null===(t=Z.current)||void 0===t?void 0:t.createAnswer();case 6:return c=e.sent,e.next=9,Z.current.setLocalDescription(c);case 9:null===(n=R.current)||void 0===n||n.emit("answer",{answer:c,info:E.current});case 10:case"end":return e.stop()}},e)})),function(e){return r.apply(this,arguments)})),R.current.on("receive_answer",(t=(0,o.Z)(u().mark(function e(r){var t;return u().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,null===(t=Z.current)||void 0===t?void 0:t.setRemoteDescription(r);case 2:case"end":return e.stop()}},e)})),function(e){return t.apply(this,arguments)})),R.current.on("add_candidate",(n=(0,o.Z)(u().mark(function e(r){var t;return u().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:null===(t=Z.current)||void 0===t||t.addIceCandidate(r);case 1:case"end":return e.stop()}},e)})),function(e){return n.apply(this,arguments)}))};function A(){return(A=(0,o.Z)(u().mark(function e(){return u().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!D.current){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,navigator.mediaDevices.getUserMedia({video:!p.tq||{facingMode:"user"},audio:!0}).catch(function(e){console.log("error happen: ".concat(e.name))});case 4:if(e.t0=e.sent,e.t0){e.next=7;break}e.t0=null;case 7:D.current=e.t0,D&&(q(!0),F.current&&D.current&&(F.current.srcObject=D.current));case 9:case"end":return e.stop()}},e)}))).apply(this,arguments)}return(0,i.useEffect)(function(){console.log("created lifetime");var e=new URLSearchParams(location.search);return p.jU&&new n,S.current=e.get("roomId")||"",S.current&&y(!0),B().then(function(){G()}),window.addEventListener("beforeunload",M),function(){var e,r;console.log(999,E.current),M(),null===(e=R.current)||void 0===e||e.disconnect(),null===(r=R.current)||void 0===r||r.off(),R.current=null,window.removeEventListener("beforeunload",M)}},[]),(0,i.useEffect)(function(){E.current=k},[k]),(0,v.jsxs)(v.Fragment,{children:[!t&&(0,v.jsx)("div",{className:l().line_banner,children:"移动端请使用谷歌浏览器体验完整功能!!!"}),t?(0,v.jsxs)("div",{className:l().total_wrap,children:[(0,v.jsxs)("div",{className:l().local_wrap,children:[(0,v.jsx)("video",{ref:F,className:l().local_video,autoPlay:!0}),1===t&&(0,v.jsxs)("div",{className:l().local_tips,children:[(0,v.jsx)("div",{style:{marginBottom:"8px"},children:(0,v.jsx)(d.Z,{type:"loading_2",className:l().loading_icon})}),"正在等待对方进入..."]}),N||(0,v.jsx)("div",{style:{color:"#fff"},children:P.userName})]}),(0,v.jsx)("video",{ref:L,className:l().target_video,autoPlay:!0}),(0,v.jsxs)("div",{className:l().operate_wrap,children:[U||(0,v.jsx)("button",{className:"".concat(l().chat_btn," ").concat(l().back_btn),onClick:M,children:(0,v.jsx)(d.Z,{type:"back_2",style:{width:"2rem"}})}),(0,v.jsxs)("div",{className:l().room_msg,children:[w&&(0,v.jsxs)("div",{children:[(0,v.jsx)(d.Z,{type:"loading_2",className:l().loading_icon,style:{fill:"#fff"}}),"正在获取视频数据..."]}),N||(0,v.jsx)("div",{children:k.userName}),(0,v.jsxs)("div",{children:["房间号: ",k.roomId]})]}),(0,v.jsx)("button",{disabled:2!==t&&!U,className:l().chat_btn,style:{backgroundColor:U||w?"red":"green"},onClick:U||w?M:z,children:(0,v.jsx)(d.Z,{type:"chat_1",style:{width:"2rem",fill:"#FFF"}})}),2!==t&&(0,v.jsx)("button",{className:"".concat(l().chat_btn," ").concat(l().share_btn),onClick:function(){var e=new URL(location.href);e.search=new URLSearchParams({roomId:k.roomId}).toString(),(0,p.JG)(e.href),alert("邀请链接已复制")},children:(0,v.jsx)(d.Z,{type:"share",style:{width:"2rem",fill:"#FFF"}})})]})]}):(0,v.jsxs)("div",{className:l().input_wrap,children:[(0,v.jsxs)("div",{className:l().img_wrap,children:[(0,v.jsx)("img",{style:{width:"200px",margin:"10vh 0"},src:"https://wsrv.nl/?url=raw.githubusercontent.com/mirrows/photo/main/normal/2024_10_14/pic1728899129621292.png&n=-1&q=80",alt:""}),s&&!N?"":(0,v.jsxs)("div",{className:l().loading_tips,children:[(0,v.jsx)(d.Z,{type:"loading_2",className:l().loading_icon}),s?N&&"正在加入房间...":"正在连接服务器..."]})]}),(0,v.jsx)("input",{type:"text",placeholder:"请输入房间号",disabled:N,className:l().input,defaultValue:k.roomId,onInput:function(e){return j(function(r){return h(h({},r),{},{roomId:e.target.value})})}}),N||(0,v.jsx)("input",{type:"text",placeholder:"请输入用户名",className:l().input,defaultValue:k.userName,onInput:function(e){return j(function(r){return h(h({},r),{},{userName:e.target.value})})}}),(0,v.jsx)("button",{className:"normal_btn",disabled:N||!s,onClick:J,children:N?"即将进入房间...":"创建/加入房间"})]})]})}},528:function(e,r,t){(window.__NEXT_P=window.__NEXT_P||[]).push(["/demos/rtc",function(){return t(1721)}])},5494:function(e){e.exports={total_wrap:"rtc_total_wrap__mB_oN",img_wrap:"rtc_img_wrap__rWeS9",loading_tips:"rtc_loading_tips__fOgOz",loading_icon:"rtc_loading_icon__wfOHr",rotate:"rtc_rotate____jNs",input_wrap:"rtc_input_wrap__mExP5",input:"rtc_input__Lq1z2",local_wrap:"rtc_local_wrap__E9d6i",local_tips:"rtc_local_tips__8t67H",local_video:"rtc_local_video__6WAdj",target_video:"rtc_target_video__DTIyo",operate_wrap:"rtc_operate_wrap__sIOsu",room_msg:"rtc_room_msg__u5elS",chat_btn:"rtc_chat_btn__zByt7",back_btn:"rtc_back_btn__qoTkF",line_banner:"rtc_line_banner__Byl2n",share_btn:"rtc_share_btn__sw9iS"}}},function(e){e.O(0,[503,642,774,888,179],function(){return e(e.s=528)}),_N_E=e.O()}]);