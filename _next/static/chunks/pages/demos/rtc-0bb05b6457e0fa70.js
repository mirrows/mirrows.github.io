(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[826],{1721:function(e,r,t){"use strict";t.r(r),t.d(r,{__N_SSG:function(){return b},default:function(){return x}});var n,c=t(29),o=t(9499),a=t(7794),u=t.n(a),i=t(7294),s=t(5494),l=t.n(s),d=t(3806),f=t(5835),_=t(7642),v=t(1575),p=t(8984),m=t(5893);function h(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable})),t.push.apply(t,n)}return t}function g(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?h(Object(t),!0).forEach(function(r){(0,o.Z)(e,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):h(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})}return e}var w={roomId:"",userName:"",socketId:""};v.jU&&"development"===p.OB.env&&(n=t(1415));var b=!0;function x(){var e,r=(0,i.useState)(0),t=r[0],o=r[1],a=(0,i.useState)(!1),s=a[0],p=a[1],h=(0,i.useState)(!1),b=h[0],x=h[1],j=(0,i.useState)({roomId:"",userName:"",socketId:""}),k=j[0],I=j[1],N=(0,i.useRef)({roomId:"",userName:"",socketId:""}),y=(0,i.useState)(!1),O=y[0],S=y[1],P=(0,i.useRef)(""),C=(0,i.useState)(g({},w)),E=C[0],R=C[1],Z=(0,i.useRef)(g({},w)),D=(0,i.useRef)(null),F=(0,i.useRef)(null),L=(0,i.useRef)(null),T=(0,i.useRef)(null),q=(0,i.useRef)(null),U=(0,i.useState)(!1),B=U[0],J=U[1],M=(e=(0,c.Z)(u().mark(function e(){var r,t,n,c,o,a,i;return u().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!(n=localStorage.info)){e.next=14;break}return e.prev=2,(c=JSON.parse(n)).socketId="",P.current&&(c.roomId=P.current),I(c),N.current=c,e.abrupt("return");case 11:e.prev=11,e.t0=e.catch(2),console.log("fail to parse info",n);case 14:return e.next=16,(0,f.oQ)();case 16:a=(null==(o=e.sent)?void 0:null===(r=o.results)||void 0===r?void 0:null===(t=r[0])||void 0===t?void 0:t.name)||"",i={roomId:String(Math.random()).slice(4,8),userName:a?"".concat(a.first," ").concat(a.last):String(Math.random()).slice(4,8),socketId:""},P.current&&(i.roomId=P.current),N.current=i,I(i),localStorage.setItem("info",JSON.stringify(n));case 23:case"end":return e.stop()}},e,null,[[2,11]])})),function(){return e.apply(this,arguments)}),z=function(){var e;N.current.roomId&&N.current.userName&&(localStorage.setItem("info",JSON.stringify(N.current)),null===(e=D.current)||void 0===e||e.emit("create_or_join_room",{info:N.current,roomId:P.current}))},G=function(){if(console.log("leave room"),I(function(e){var r;return null===(r=D.current)||void 0===r||r.emit("room_leave",e),e}),x(!1),S(!1),R(g({},w)),Z.current=g({},w),P.current="",null!=L&&L.current){var e,r=null===(e=L.current)||void 0===e?void 0:e.getTracks();null==r||r.forEach(function(e){e.stop()}),L.current=null,T.current&&(T.current.srcObject=null)}F.current=null,q.current&&(q.current.srcObject=null),o(0),J(!1)};function A(){x(!0),I(function(e){var r;return console.log(N.current,e),null===(r=D.current)||void 0===r||r.emit("request_video",e),e})}var H=function(){var e,r,t,n;console.log("init socket"),D.current=(0,_.io)("wss://use.t-n.top",{transports:["websocket"],withCredentials:!0}),D.current.on("connected",function(e){console.log("new ID:",e),p(!0),N.current=g(g({},N.current),{},{socketId:e}),I(N.current),P.current&&z()}),D.current.on("room_full",function(){return alert("房间已满，请更换房间号ID")}),D.current.on("room_created",function(e){alert("您已创建并加入【".concat(e.roomId,"】房间")),I(e),o(1)}),D.current.on("room_joined",function(e){var r=e.user,t=e.another,n=e.result;if(404===n){alert("该房间不存在或已销毁，请检查房间号"),o(0),P.current="",S(!1);return}o(2),Z.current=r.socketId!==N.current.socketId?r:t,R(Z.current),r.socketId!==N.current.socketId&&alert("用户".concat(r.userName,"加入【").concat(r.roomId,"】房间")),n&&S(!0),console.log(r,N.current,P.current),r.socketId===N.current.socketId&&P.current&&A()}),D.current.on("room_leave",function(e){e.socketId!==N.current.socketId?(R(g({},w)),Z.current=g({},w),alert("用户".concat(e.userName,"已离开【").concat(e.roomId,"】房间")),o(0),G()):o(0)}),D.current.on("receive_video",function(e){var r;e.socketId!==N.current.socketId&&window.confirm("您要接受用户".concat(e.userName,"的视频电话邀请吗？"))&&(null===(r=D.current)||void 0===r||r.emit("accept_video",N.current))}),D.current.on("accept_video",(e=(0,c.Z)(u().mark(function e(r){var t,n,c,o;return u().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return x(!0),e.next=3,function(){return V.apply(this,arguments)}();case 3:if(function(){var e;F.current||(F.current=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun.miwifi.com"},{urls:"stun:stun.voipbuster.com"},{urls:"stun:stun.qq.com"},{urls:"turn:stun.t-n.top:3478",username:"test12138",credential:"test12138"}]})),F.current.onicecandidate=function(e){var r;return null===(r=D.current)||void 0===r?void 0:r.emit("add_candidate",{candidate:e.candidate,info:N.current,to:Z.current})},F.current.oniceconnectionstatechange=function(){var e,r,t,n;(null===(e=F.current)||void 0===e?void 0:e.iceConnectionState)==="connected"&&x(!1),((null===(r=F.current)||void 0===r?void 0:r.iceConnectionState)==="disconnected"||(null===(t=F.current)||void 0===t?void 0:t.iceConnectionState)==="failed")&&(x(!1),alert("连接失败，请重新连接"),G()),console.log("oniceconnectionstatechange: ".concat(null===(n=F.current)||void 0===n?void 0:n.iceConnectionState))},F.current.onsignalingstatechange=function(){var e;console.log("onsignalingstatechange: ".concat(null===(e=F.current)||void 0===e?void 0:e.signalingState))},F.current.ontrack=function(e){return q.current?q.current.srcObject=e.streams[0]:""},F.current.onicegatheringstatechange=function(){var e;console.log("onicegatheringstatechange: ".concat(null===(e=F.current)||void 0===e?void 0:e.iceGatheringState))},null===(e=L.current)||void 0===e||e.getTracks().forEach(function(e){if(L.current){var r;null===(r=F.current)||void 0===r||r.addTrack(e,L.current)}})}(),!(r.socketId!==N.current.socketId)){e.next=12;break}return e.next=7,null===(t=F.current)||void 0===t?void 0:t.createOffer();case 7:return o=e.sent,e.next=10,null===(n=F.current)||void 0===n?void 0:n.setLocalDescription(o);case 10:console.log(Z.current),null===(c=D.current)||void 0===c||c.emit("offer",{offer:o,info:N.current,to:Z.current});case 12:case"end":return e.stop()}},e)})),function(r){return e.apply(this,arguments)})),D.current.on("receive_offer",(r=(0,c.Z)(u().mark(function e(r){var t,n,c,o,a,i;return u().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(c=r.offer,o=r.info,a=r.to,F.current){e.next=3;break}return e.abrupt("return");case 3:return e.next=5,F.current.setRemoteDescription(c);case 5:return e.next=7,null===(t=F.current)||void 0===t?void 0:t.createAnswer();case 7:return i=e.sent,e.next=10,F.current.setLocalDescription(i);case 10:null===(n=D.current)||void 0===n||n.emit("answer",{answer:i,info:a,to:o});case 11:case"end":return e.stop()}},e)})),function(e){return r.apply(this,arguments)})),D.current.on("receive_answer",(t=(0,c.Z)(u().mark(function e(r){var t,n;return u().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.answer,e.next=3,null===(t=F.current)||void 0===t?void 0:t.setRemoteDescription(n);case 3:case"end":return e.stop()}},e)})),function(e){return t.apply(this,arguments)})),D.current.on("add_candidate",(n=(0,c.Z)(u().mark(function e(r){var t,n;return u().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:n=r.candidate,null===(t=F.current)||void 0===t||t.addIceCandidate(n);case 2:case"end":return e.stop()}},e)})),function(e){return n.apply(this,arguments)}))};function V(){return(V=(0,c.Z)(u().mark(function e(){return u().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!L.current){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,navigator.mediaDevices.getUserMedia({video:!v.tq||{facingMode:"user"},audio:!0}).catch(function(e){console.log("error happen: ".concat(e.name))});case 4:if(e.t0=e.sent,e.t0){e.next=7;break}e.t0=null;case 7:L.current=e.t0,L&&(J(!0),T.current&&L.current&&(T.current.srcObject=L.current));case 9:case"end":return e.stop()}},e)}))).apply(this,arguments)}return(0,i.useEffect)(function(){console.log("created lifetime");var e=new URLSearchParams(location.search);return v.jU&&new n,P.current=e.get("roomId")||"",P.current&&S(!0),M().then(function(){H()}),window.addEventListener("beforeunload",G),function(){var e,r;console.log(999,N.current),G(),null===(e=D.current)||void 0===e||e.disconnect(),null===(r=D.current)||void 0===r||r.off(),D.current=null,window.removeEventListener("beforeunload",G)}},[]),(0,i.useEffect)(function(){N.current=k},[k]),(0,m.jsxs)(m.Fragment,{children:[!t&&(0,m.jsxs)("div",{className:l().line_banner,children:[(0,m.jsx)("div",{children:"作者很穷，只能在局域网里玩玩，"}),(0,m.jsx)("div",{children:"推荐使用谷歌浏览器访问这个页面哈..."})]}),t?(0,m.jsxs)("div",{className:l().total_wrap,children:[(0,m.jsxs)("div",{className:l().local_wrap,children:[(0,m.jsx)("video",{ref:T,className:l().local_video,autoPlay:!0}),1===t&&(0,m.jsxs)("div",{className:l().local_tips,children:[(0,m.jsx)("div",{style:{marginBottom:"8px"},children:(0,m.jsx)(d.Z,{type:"loading_2",className:l().loading_icon})}),"正在等待对方进入..."]}),O||(0,m.jsx)("div",{style:{color:"#fff"},children:E.userName})]}),(0,m.jsx)("video",{ref:q,className:l().target_video,autoPlay:!0}),(0,m.jsxs)("div",{className:l().operate_wrap,children:[B||(0,m.jsx)("button",{className:"".concat(l().chat_btn," ").concat(l().back_btn),onClick:G,children:(0,m.jsx)(d.Z,{type:"back_2",style:{width:"2rem"}})}),(0,m.jsxs)("div",{className:l().room_msg,children:[b&&(0,m.jsxs)("div",{children:[(0,m.jsx)(d.Z,{type:"loading_2",className:l().loading_icon,style:{fill:"#fff"}}),"正在获取视频数据..."]}),O||(0,m.jsx)("div",{children:k.userName}),(0,m.jsxs)("div",{children:["房间号: ",k.roomId]})]}),(0,m.jsx)("button",{disabled:2!==t&&!B,className:l().chat_btn,style:{backgroundColor:B||b?"red":"green"},onClick:B||b?G:A,children:(0,m.jsx)(d.Z,{type:"chat_1",style:{width:"2rem",fill:"#FFF"}})}),2!==t&&(0,m.jsx)("button",{className:"".concat(l().chat_btn," ").concat(l().share_btn),onClick:function(){var e=new URL(location.href);e.search=new URLSearchParams({roomId:k.roomId}).toString(),(0,v.JG)(e.href),alert("邀请链接已复制")},children:(0,m.jsx)(d.Z,{type:"share",style:{width:"2rem",fill:"#FFF"}})})]})]}):(0,m.jsxs)("div",{className:l().input_wrap,children:[(0,m.jsxs)("div",{className:l().img_wrap,children:[(0,m.jsx)("img",{style:{width:"200px",margin:"10vh 0"},src:"https://wsrv.nl/?url=raw.githubusercontent.com/mirrows/photo/main/normal/2024_10_14/pic1728899129621292.png&n=-1&q=80",alt:""}),s&&!O?"":(0,m.jsxs)("div",{className:l().loading_tips,children:[(0,m.jsx)(d.Z,{type:"loading_2",className:l().loading_icon}),s?O&&"正在加入房间...":"正在连接服务器..."]})]}),(0,m.jsx)("input",{type:"text",placeholder:"请输入房间号",disabled:O,className:l().input,defaultValue:k.roomId,onInput:function(e){return I(function(r){return g(g({},r),{},{roomId:e.target.value})})}}),O||(0,m.jsx)("input",{type:"text",placeholder:"请输入用户名",className:l().input,defaultValue:k.userName,onInput:function(e){return I(function(r){return g(g({},r),{},{userName:e.target.value})})}}),(0,m.jsx)("button",{className:"normal_btn",disabled:O||!s,onClick:z,children:O?"即将进入房间...":"创建/加入房间"})]})]})}},528:function(e,r,t){(window.__NEXT_P=window.__NEXT_P||[]).push(["/demos/rtc",function(){return t(1721)}])},5494:function(e){e.exports={total_wrap:"rtc_total_wrap__mB_oN",img_wrap:"rtc_img_wrap__rWeS9",loading_tips:"rtc_loading_tips__fOgOz",loading_icon:"rtc_loading_icon__wfOHr",rotate:"rtc_rotate____jNs",input_wrap:"rtc_input_wrap__mExP5",input:"rtc_input__Lq1z2",local_wrap:"rtc_local_wrap__E9d6i",local_tips:"rtc_local_tips__8t67H",local_video:"rtc_local_video__6WAdj",target_video:"rtc_target_video__DTIyo",operate_wrap:"rtc_operate_wrap__sIOsu",room_msg:"rtc_room_msg__u5elS",chat_btn:"rtc_chat_btn__zByt7",back_btn:"rtc_back_btn__qoTkF",line_banner:"rtc_line_banner__Byl2n",share_btn:"rtc_share_btn__sw9iS"}}},function(e){e.O(0,[503,642,774,888,179],function(){return e(e.s=528)}),_N_E=e.O()}]);