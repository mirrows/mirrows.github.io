(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[826],{1721:function(e,r,n){"use strict";n.r(r),n.d(r,{__N_SSG:function(){return b},default:function(){return x}});var t,c=n(29),o=n(9499),a=n(7794),u=n.n(a),i=n(7294),s=n(5494),l=n.n(s),d=n(3806),f=n(5835),_=n(7642),v=n(1575),p=n(8984),m=n(5893);function h(e,r){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);r&&(t=t.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable})),n.push.apply(n,t)}return n}function g(e){for(var r=1;r<arguments.length;r++){var n=null!=arguments[r]?arguments[r]:{};r%2?h(Object(n),!0).forEach(function(r){(0,o.Z)(e,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):h(Object(n)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(n,r))})}return e}var w={roomId:"",userName:"",socketId:""};v.jU&&"development"===p.OB.env&&(t=n(1415));var b=!0;function x(){var e,r=(0,i.useState)(0),n=r[0],o=r[1],a=(0,i.useState)(!1),s=a[0],h=a[1],b=(0,i.useState)(!1),x=b[0],j=b[1],k=(0,i.useState)({roomId:"",userName:"",socketId:""}),I=k[0],N=k[1],y=(0,i.useRef)({roomId:"",userName:"",socketId:""}),O=(0,i.useState)(!1),S=O[0],P=O[1],C=(0,i.useRef)(""),E=(0,i.useState)(g({},w)),R=E[0],Z=E[1],D=(0,i.useRef)(g({},w)),F=(0,i.useRef)(null),L=(0,i.useRef)(null),T=(0,i.useRef)(null),q=(0,i.useRef)(null),B=(0,i.useRef)(null),U=(0,i.useState)(!1),J=U[0],M=U[1],z=(e=(0,c.Z)(u().mark(function e(){var r,n,t,c,o,a,i;return u().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!(t=localStorage.info)){e.next=14;break}return e.prev=2,(c=JSON.parse(t)).socketId="",C.current&&(c.roomId=C.current),N(c),y.current=c,e.abrupt("return");case 11:e.prev=11,e.t0=e.catch(2),console.log("fail to parse info",t);case 14:return e.next=16,(0,f.oQ)();case 16:a=(null==(o=e.sent)?void 0:null===(r=o.results)||void 0===r?void 0:null===(n=r[0])||void 0===n?void 0:n.name)||"",i={roomId:String(Math.random()).slice(4,8),userName:a?"".concat(a.first," ").concat(a.last):String(Math.random()).slice(4,8),socketId:""},C.current&&(i.roomId=C.current),y.current=i,N(i),localStorage.setItem("info",JSON.stringify(t));case 23:case"end":return e.stop()}},e,null,[[2,11]])})),function(){return e.apply(this,arguments)}),G=function(){var e;y.current.roomId&&y.current.userName&&(localStorage.setItem("info",JSON.stringify(y.current)),null===(e=F.current)||void 0===e||e.emit("create_or_join_room",{info:y.current,roomId:C.current}))},A=function(){if(console.log("leave room"),N(function(e){var r;return null===(r=F.current)||void 0===r||r.emit("room_leave",e),e}),j(!1),P(!1),Z(g({},w)),D.current=g({},w),C.current="",null!=T&&T.current){var e,r=null===(e=T.current)||void 0===e?void 0:e.getTracks();null==r||r.forEach(function(e){e.stop()}),T.current=null,q.current&&(q.current.srcObject=null)}L.current=null,B.current&&(B.current.srcObject=null),o(0),M(!1)};function H(){j(!0),N(function(e){var r;return console.log(y.current,e),null===(r=F.current)||void 0===r||r.emit("request_video",e),e})}var V=function(){var e,r,n,t;console.log("init socket"),F.current=(0,_.io)("wss://use.t-n.top",{transports:["websocket"],withCredentials:!0}),F.current.on("connected",function(e){console.log("new ID:",e),h(!0),y.current=g(g({},y.current),{},{socketId:e}),N(y.current),C.current&&G()}),F.current.on("room_full",function(){return alert("房间已满，请更换房间号ID")}),F.current.on("room_created",function(e){alert("您已创建并加入【".concat(e.roomId,"】房间")),N(e),o(1)}),F.current.on("room_joined",function(e){var r=e.user,n=e.another,t=e.result;if(404===t){alert("该房间不存在或已销毁，请检查房间号"),o(0),C.current="",P(!1);return}o(2),D.current=r.socketId!==y.current.socketId?r:n,Z(D.current),r.socketId!==y.current.socketId&&alert("用户".concat(r.userName,"加入【").concat(r.roomId,"】房间")),t&&P(!0),console.log(r,y.current,C.current),r.socketId===y.current.socketId&&C.current&&H()}),F.current.on("room_leave",function(e){e.socketId!==y.current.socketId?(Z(g({},w)),D.current=g({},w),alert("用户".concat(e.userName,"已离开【").concat(e.roomId,"】房间")),o(0),A()):o(0)}),F.current.on("receive_video",function(e){var r;e.socketId!==y.current.socketId&&window.confirm("您要接受用户".concat(e.userName,"的视频电话邀请吗？"))&&(null===(r=F.current)||void 0===r||r.emit("accept_video",y.current))}),F.current.on("accept_video",(e=(0,c.Z)(u().mark(function e(r){var n,t,c,o;return u().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return j(!0),e.next=3,function(){return W.apply(this,arguments)}();case 3:if(function(){var e;L.current||(L.current=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun.miwifi.com"},{urls:"stun:stun.voipbuster.com"},{urls:"stun:stun.qq.com"},{urls:"turn:stun.t-n.top:3478",username:"test12138",credential:"test12138"}]})),L.current.onicecandidate=function(e){var r;return null===(r=F.current)||void 0===r?void 0:r.emit("add_candidate",{candidate:e.candidate,info:y.current,to:D.current})},L.current.oniceconnectionstatechange=function(){var e,r,n,t;(null===(e=L.current)||void 0===e?void 0:e.iceConnectionState)==="connected"&&j(!1),((null===(r=L.current)||void 0===r?void 0:r.iceConnectionState)==="disconnected"||(null===(n=L.current)||void 0===n?void 0:n.iceConnectionState)==="failed")&&(j(!1),alert("连接失败，请重新连接"),A()),console.log("oniceconnectionstatechange: ".concat(null===(t=L.current)||void 0===t?void 0:t.iceConnectionState))},L.current.onsignalingstatechange=function(){var e;console.log("onsignalingstatechange: ".concat(null===(e=L.current)||void 0===e?void 0:e.signalingState))},L.current.ontrack=function(e){return B.current?B.current.srcObject=e.streams[0]:""},L.current.onicegatheringstatechange=function(){var e;console.log("onicegatheringstatechange: ".concat(null===(e=L.current)||void 0===e?void 0:e.iceGatheringState))},null===(e=T.current)||void 0===e||e.getTracks().forEach(function(e){if(T.current){var r;null===(r=L.current)||void 0===r||r.addTrack(e,T.current)}})}(),!(r.socketId!==y.current.socketId)){e.next=12;break}return e.next=7,null===(n=L.current)||void 0===n?void 0:n.createOffer();case 7:return o=e.sent,e.next=10,null===(t=L.current)||void 0===t?void 0:t.setLocalDescription(o);case 10:console.log(D.current),null===(c=F.current)||void 0===c||c.emit("offer",{offer:o,info:y.current,to:D.current});case 12:case"end":return e.stop()}},e)})),function(r){return e.apply(this,arguments)})),F.current.on("receive_offer",(r=(0,c.Z)(u().mark(function e(r){var n,t,c,o,a,i;return u().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(c=r.offer,o=r.info,a=r.to,L.current){e.next=3;break}return e.abrupt("return");case 3:return e.next=5,L.current.setRemoteDescription(c);case 5:return e.next=7,null===(n=L.current)||void 0===n?void 0:n.createAnswer();case 7:return i=e.sent,e.next=10,L.current.setLocalDescription(i);case 10:null===(t=F.current)||void 0===t||t.emit("answer",{answer:i,info:a,to:o});case 11:case"end":return e.stop()}},e)})),function(e){return r.apply(this,arguments)})),F.current.on("receive_answer",(n=(0,c.Z)(u().mark(function e(r){var n,t;return u().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.answer,e.next=3,null===(n=L.current)||void 0===n?void 0:n.setRemoteDescription(t);case 3:case"end":return e.stop()}},e)})),function(e){return n.apply(this,arguments)})),F.current.on("add_candidate",(t=(0,c.Z)(u().mark(function e(r){var n,t;return u().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:t=r.candidate,null===(n=L.current)||void 0===n||n.addIceCandidate(t);case 2:case"end":return e.stop()}},e)})),function(e){return t.apply(this,arguments)}))};function W(){return(W=(0,c.Z)(u().mark(function e(){return u().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!T.current){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,navigator.mediaDevices.getUserMedia({video:!v.tq||{facingMode:"user"},audio:!0}).catch(function(e){console.log("error happen: ".concat(e.name))});case 4:if(e.t0=e.sent,e.t0){e.next=7;break}e.t0=null;case 7:T.current=e.t0,T&&(M(!0),q.current&&T.current&&(q.current.srcObject=T.current));case 9:case"end":return e.stop()}},e)}))).apply(this,arguments)}return(0,i.useEffect)(function(){console.log("created lifetime");var e=new URLSearchParams(location.search);return v.jU&&"development"===p.OB.env&&new t,C.current=e.get("roomId")||"",C.current&&P(!0),z().then(function(){V()}),window.addEventListener("beforeunload",A),function(){var e,r;console.log(999,y.current),A(),null===(e=F.current)||void 0===e||e.disconnect(),null===(r=F.current)||void 0===r||r.off(),F.current=null,window.removeEventListener("beforeunload",A)}},[]),(0,i.useEffect)(function(){y.current=I},[I]),(0,m.jsxs)(m.Fragment,{children:[!n&&(0,m.jsxs)("div",{className:l().line_banner,children:[(0,m.jsx)("div",{children:"作者很穷，只能在局域网里玩玩，"}),(0,m.jsx)("div",{children:"推荐使用谷歌浏览器访问这个页面哈..."})]}),n?(0,m.jsxs)("div",{className:l().total_wrap,children:[(0,m.jsxs)("div",{className:l().local_wrap,children:[(0,m.jsx)("video",{ref:q,className:l().local_video,autoPlay:!0}),1===n&&(0,m.jsxs)("div",{className:l().local_tips,children:[(0,m.jsx)("div",{style:{marginBottom:"8px"},children:(0,m.jsx)(d.Z,{type:"loading_2",className:l().loading_icon})}),"正在等待对方进入..."]}),S||(0,m.jsx)("div",{style:{color:"#fff"},children:R.userName})]}),(0,m.jsx)("video",{ref:B,className:l().target_video,autoPlay:!0}),(0,m.jsxs)("div",{className:l().operate_wrap,children:[J||(0,m.jsx)("button",{className:"".concat(l().chat_btn," ").concat(l().back_btn),onClick:A,children:(0,m.jsx)(d.Z,{type:"back_2",style:{width:"2rem"}})}),(0,m.jsxs)("div",{className:l().room_msg,children:[x&&(0,m.jsxs)("div",{children:[(0,m.jsx)(d.Z,{type:"loading_2",className:l().loading_icon,style:{fill:"#fff"}}),"正在获取视频数据..."]}),S||(0,m.jsx)("div",{children:I.userName}),(0,m.jsxs)("div",{children:["房间号: ",I.roomId]})]}),(0,m.jsx)("button",{disabled:2!==n&&!J,className:l().chat_btn,style:{backgroundColor:J||x?"red":"green"},onClick:J||x?A:H,children:(0,m.jsx)(d.Z,{type:"chat_1",style:{width:"2rem",fill:"#FFF"}})}),2!==n&&(0,m.jsx)("button",{className:"".concat(l().chat_btn," ").concat(l().share_btn),onClick:function(){var e=new URL(location.href);e.search=new URLSearchParams({roomId:I.roomId}).toString(),(0,v.JG)(e.href),alert("邀请链接已复制")},children:(0,m.jsx)(d.Z,{type:"share",style:{width:"2rem",fill:"#FFF"}})})]})]}):(0,m.jsxs)("div",{className:l().input_wrap,children:[(0,m.jsxs)("div",{className:l().img_wrap,children:[(0,m.jsx)("img",{style:{width:"200px",margin:"10vh 0"},src:"https://wsrv.nl/?url=raw.githubusercontent.com/mirrows/photo/main/normal/2024_10_14/pic1728899129621292.png&n=-1&q=80",alt:""}),s&&!S?"":(0,m.jsxs)("div",{className:l().loading_tips,children:[(0,m.jsx)(d.Z,{type:"loading_2",className:l().loading_icon}),s?S&&"正在加入房间...":"正在连接服务器..."]})]}),(0,m.jsx)("input",{type:"text",placeholder:"请输入房间号",disabled:S,className:l().input,defaultValue:I.roomId,onInput:function(e){return N(function(r){return g(g({},r),{},{roomId:e.target.value})})}}),S||(0,m.jsx)("input",{type:"text",placeholder:"请输入用户名",className:l().input,defaultValue:I.userName,onInput:function(e){return N(function(r){return g(g({},r),{},{userName:e.target.value})})}}),(0,m.jsx)("button",{className:"normal_btn",disabled:S||!s,onClick:G,children:S?"即将进入房间...":"创建/加入房间"})]})]})}},528:function(e,r,n){(window.__NEXT_P=window.__NEXT_P||[]).push(["/demos/rtc",function(){return n(1721)}])},5494:function(e){e.exports={total_wrap:"rtc_total_wrap__mB_oN",img_wrap:"rtc_img_wrap__rWeS9",loading_tips:"rtc_loading_tips__fOgOz",loading_icon:"rtc_loading_icon__wfOHr",rotate:"rtc_rotate____jNs",input_wrap:"rtc_input_wrap__mExP5",input:"rtc_input__Lq1z2",local_wrap:"rtc_local_wrap__E9d6i",local_tips:"rtc_local_tips__8t67H",local_video:"rtc_local_video__6WAdj",target_video:"rtc_target_video__DTIyo",operate_wrap:"rtc_operate_wrap__sIOsu",room_msg:"rtc_room_msg__u5elS",chat_btn:"rtc_chat_btn__zByt7",back_btn:"rtc_back_btn__qoTkF",line_banner:"rtc_line_banner__Byl2n",share_btn:"rtc_share_btn__sw9iS"}}},function(e){e.O(0,[503,642,774,888,179],function(){return e(e.s=528)}),_N_E=e.O()}]);