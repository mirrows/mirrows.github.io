(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[153],{1550:function(e,t,n){"use strict";n.r(t),n.d(t,{__N_SSG:function(){return D},default:function(){return T}});var r=n(29),c=n(7794),o=n.n(c),a=n(7294),i=n(1270),u=n.n(i),s=n(5835),l=n(7642),d=n(9499),f=n(4730),p=n(9922),_=n(3806),m=n(3143),v=n.n(m),h=n(8924),w=n.n(h),b=n(9980),g=n.n(b),x=n(5893),y=["isCanSubmit","onSubmit","placeholder"];function j(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function k(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?j(Object(n),!0).forEach(function(t){(0,d.Z)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):j(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}var O=(0,a.forwardRef)(function(e,t){var n=e.isCanSubmit,r=void 0===n||n,c=e.onSubmit,o=e.placeholder,i=(0,f.Z)(e,y),u=new(g()),s=(0,a.useRef)(null),l=(0,a.useRef)(null),d=(0,a.useState)(!1),m=d[0],h=d[1],b=(0,a.useRef)(null),j=(0,a.useState)(!1),O=j[0],S=j[1],I=function(){if(null!==(e=l.current)&&void 0!==e&&e.value){var e,t=w()(u.render(l.current.value));(null==b?void 0:b.current)&&(b.current.innerHTML=t)}};return(0,a.useImperativeHandle)(t,function(){return{insertContent:function(e){l.current&&(l.current.value+=e)}}}),(0,x.jsxs)(x.Fragment,{children:[(0,x.jsxs)(p.Z,k(k({ref:s,clickable:!1,className:v().my_textarea_wrap},i),{},{autoUpload:!0,operateLineStyle:m?{marginTop:"0"}:{},onFinish:function(e){console.log(e),setTimeout(function(){l.current&&(l.current.value=l.current.value+e.map(function(e){var t=e.normal;return"\n![".concat(t.name,"](https://wsrv.nl/?url=").concat(t.download_url.replace("https://",""),")")}).join("\n"),l.current.focus())})},children:[(0,x.jsxs)("div",{children:[(0,x.jsx)("label",{htmlFor:"commentInput"}),(0,x.jsx)("textarea",{id:"commentInput",ref:l,className:v().text_area,rows:8,style:{display:m?"none":"block"},placeholder:void 0===o?"请输入, 支持markdown语法......":o,suppressContentEditableWarning:!0,contentEditable:!0,onPaste:function(e){var t,n=[],r=e.clipboardData.items;if(r&&r.length){for(var c=0;c<r.length;c++)if(-1!==r[c].type.indexOf("image")){var o=r[c].getAsFile();o&&n.push(o)}}n&&(null===(t=s.current)||void 0===t||t.addFile(n))},onInput:function(){var e;S(!(!r||!(null!==(e=l.current)&&void 0!==e&&e.value)))}})]}),(0,x.jsxs)("div",{className:v().operate_wrap,children:[(0,x.jsx)(_.Z,{type:"code",className:v().preview,alt:"preview",onClick:function(e){e.stopPropagation(),h(function(e){return e||I(),!e})}}),(0,x.jsx)("button",{className:v().submit,disabled:!O,"aria-label":"submit comment",onClick:function(e){var t;e.stopPropagation(),c({content:null===(t=l.current)||void 0===t?void 0:t.value}),l.current&&(l.current.value="")},children:"add comment"})]})]})),(0,x.jsx)("div",{className:v().preview_detail_wrap,style:{display:m?"block":"none"},children:(0,x.jsx)("div",{ref:b,className:"".concat(v().blog_content," ").concat(v().preview_detail)})})]})}),S=n(8984),I=n(277),N=["className","text"];function C(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function P(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?C(Object(n),!0).forEach(function(t){(0,d.Z)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):C(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}var E=function(e){var t=e.className,n=e.text,r=(0,f.Z)(e,N),c=new(g());return(0,x.jsx)("div",P(P({className:"md_detail ".concat(t)},r),{},{dangerouslySetInnerHTML:{__html:(0,I.K)(w()(c.render(n||"")))}}))},D=!0;function T(){var e,t=(0,a.useState)("https://raw.githubusercontent.com/mirrows/photo/main/normal/2024_10_28/pic1730078673558002.jpg")[0],n=(0,a.useRef)(0),c=(0,a.useState)([]),i=(c[0],c[1]),d=(0,a.useRef)([]),f=(0,a.useState)(!1),p=(f[0],f[1]),_=(0,a.useRef)(null),m=(0,a.useRef)(""),v=(0,a.useState)({roomId:"",userName:"",socketId:"",dc:null,pc:null}),h=v[0],w=v[1],b=(0,a.useRef)({roomId:"",userName:"",socketId:"",dc:null,pc:null}),g=(0,a.useState)(!1),y=g[0],j=g[1],k=(0,a.useState)([]),I=k[0],N=k[1],C=(e=(0,r.Z)(o().mark(function e(){var t,n,r,c,a,i,u;return o().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!(r=localStorage.info)){e.next=13;break}return e.prev=2,(c=JSON.parse(r)).socketId="",w(c),b.current=c,e.abrupt("return");case 10:e.prev=10,e.t0=e.catch(2),console.log("fail to parse info",r);case 13:return e.next=15,(0,s.oQ)();case 15:i=(null==(a=e.sent)?void 0:null===(t=a.results)||void 0===t?void 0:null===(n=t[0])||void 0===n?void 0:n.name)||"",u={roomId:String(Math.random()).slice(4,8),userName:i?"".concat(i.first," ").concat(i.last):String(Math.random()).slice(4,8),socketId:"",dc:null,pc:null},b.current=u,w(u),localStorage.setItem("info",JSON.stringify(u));case 21:case"end":return e.stop()}},e,null,[[2,10]])})),function(){return e.apply(this,arguments)}),P=function(e){console.log(e,d.current);var t={id:S.Tw.get("".concat(m.current).concat(b.current.socketId)),type:"text",content:e,from:b.current,time:new Date().toLocaleString()};N(function(e){return e.concat(t)}),d.current.forEach(function(e){var n;null===(n=e.dc)||void 0===n||n.send(JSON.stringify(t))})},D=function(){var e;b.current.userName&&(localStorage.setItem("info",JSON.stringify(b.current)),null===(e=_.current)||void 0===e||e.emit("join",{info:b.current}))},T=function(){var e;console.log("leave room"),d.current.forEach(function(e){var t;null===(t=e.dc)||void 0===t||t.send(JSON.stringify({id:S.Tw.get("".concat(m.current).concat(b.current.socketId)),type:"tips",content:"用户".concat(b.current.userName,"离开房间"),from:b.current,time:new Date().toLocaleString()}))}),null===(e=_.current)||void 0===e||e.emit("leave",b.current)};function R(){return(R=(0,r.Z)(o().mark(function e(){return o().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:d.current.forEach(function(){var e=(0,r.Z)(o().mark(function e(t){var n,r,c,a;return o().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("requestVideoCall"),e.next=3,null===(n=t.pc)||void 0===n?void 0:n.createOffer();case 3:return a=e.sent,e.next=6,null===(r=t.pc)||void 0===r?void 0:r.setLocalDescription(a);case 6:null===(c=_.current)||void 0===c||c.emit("offer",{offer:a,info:b.current,to:t});case 7:case"end":return e.stop()}},e)}));return function(t){return e.apply(this,arguments)}}());case 1:case"end":return e.stop()}},e)}))).apply(this,arguments)}var M=function(){var e,t,n;_.current=(0,l.io)(S.OB.extraUrl,{transports:["websocket"],withCredentials:!0}),_.current.on("connected",function(e){console.log("new ID:",e),p(!0),b.current.socketId=e,w(b.current),D()}),_.current.on("join",function(e){var t=e.user,n=e.another;if(404===e.result){console.warn("该房间不存在或已销毁，请检查房间号");return}var r=d.current.reduce(function(e,t){return e[t.socketId]=t,e},{}),c=n.filter(function(e){return e.socketId!==b.current.socketId}).map(function(e){return r[e.socketId]||e});i(c),d.current=c,t.socketId!==b.current.socketId?(N(function(e){return e.concat({id:S.Tw.get("".concat(m.current).concat(b.current.socketId)),type:"tips",content:"用户".concat(t.userName,"加入房间"),from:t,time:new Date().toLocaleString()})}),Z(t)):(N(function(e){return e.concat({id:S.Tw.get("".concat(m.current).concat(b.current.socketId)),type:"tips",content:"你已加入房间",from:t,time:new Date().toLocaleString()})}),j(!0),d.current.forEach(function(e){Z(e,!0)})),t.socketId===b.current.socketId&&c.length>0&&function(){R.apply(this,arguments)}()}),_.current.on("receive_offer",(e=(0,r.Z)(o().mark(function e(t){var n,r,c,a,i,u,s;return o().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(c=t.info,a=t.to,i=t.offer,console.log("receive offer"),null!=(u=d.current.find(function(e){return e.socketId===c.socketId}))&&u.pc){e.next=5;break}return e.abrupt("return");case 5:return e.next=7,u.pc.setRemoteDescription(i);case 7:return e.next=9,null===(n=u.pc)||void 0===n?void 0:n.createAnswer();case 9:return s=e.sent,e.next=12,u.pc.setLocalDescription(s);case 12:null===(r=_.current)||void 0===r||r.emit("answer",{answer:s,info:a,to:c});case 13:case"end":return e.stop()}},e)})),function(t){return e.apply(this,arguments)})),_.current.on("receive_answer",(t=(0,r.Z)(o().mark(function e(t){var n,r,c,a;return o().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.info,c=t.answer,console.log("receive answer"),null!=(a=d.current.find(function(e){return e.socketId===r.socketId}))&&a.pc){e.next=5;break}return e.abrupt("return");case 5:return e.next=7,null===(n=a.pc)||void 0===n?void 0:n.setRemoteDescription(c);case 7:case"end":return e.stop()}},e)})),function(e){return t.apply(this,arguments)})),_.current.on("add_candidate",(n=(0,r.Z)(o().mark(function e(t){var n,r,c,a;return o().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.info,c=t.candidate,console.log("add_candidate"),null!=(a=d.current.find(function(e){return e.socketId===r.socketId}))&&a.pc){e.next=5;break}return e.abrupt("return");case 5:null===(n=a.pc)||void 0===n||n.addIceCandidate(c);case 6:case"end":return e.stop()}},e)})),function(e){return n.apply(this,arguments)}))};function Z(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=d.current.find(function(t){return t.socketId===e.socketId});n&&(null!=n&&n.pc||(n.pc=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun.miwifi.com"},{urls:"stun:stun.voipbuster.com"},{urls:"stun:stun.qq.com"},{urls:"turn:stun.t-n.top:3478",username:"test12138",credential:"test12138"}]})),t?(n.dc=n.pc.createDataChannel("my channel"),console.log("new datachannel"),L(n.dc)):(console.log("ready to datachannel"),n.pc.ondatachannel=function(e){console.log("on datachannel"),n.dc=e.channel,n.dc.onopen=function(){console.log("Data channel is open!")},L(n.dc)}),n.pc.onicecandidate=function(e){var t,n,r=null===(t=e.candidate)||void 0===t?void 0:null===(n=t.candidate)||void 0===n?void 0:n.match(/([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/);r&&(m.current=r[0]),d.current.forEach(function(t){var n;null===(n=_.current)||void 0===n||n.emit("add_candidate",{candidate:e.candidate,info:b.current,to:t})})},n.pc.oniceconnectionstatechange=function(){var e,t,r,c;null===(e=n.pc)||void 0===e||e.iceConnectionState,((null===(t=n.pc)||void 0===t?void 0:t.iceConnectionState)==="disconnected"||(null===(r=n.pc)||void 0===r?void 0:r.iceConnectionState)==="failed")&&console.warn("连接失败，请重新连接"),console.log("oniceconnectionstatechange: ".concat(null===(c=n.pc)||void 0===c?void 0:c.iceConnectionState))})}var L=function(e){e.onmessage=function(e){console.log("received msg: "+e.data);try{N(function(t){return t.concat(JSON.parse(e.data))})}catch(t){console.log("fail to parse msg",e.data)}}};return(0,a.useEffect)(function(){return C().then(function(){n.current,n.current>0?n.current-=1:M()}),window.addEventListener("beforeunload",T),function(){var e,t;T(),n.current+=1,null===(e=_.current)||void 0===e||e.disconnect(),null===(t=_.current)||void 0===t||t.off(),_.current=null,window.removeEventListener("beforeunload",T)}},[]),(0,x.jsx)(x.Fragment,{children:(0,x.jsx)("div",{className:u().chat_wrap,style:{backgroundImage:"url('".concat(t,"')")},children:(0,x.jsxs)("div",{className:u().main_container,children:[(0,x.jsxs)("div",{children:[(0,x.jsx)("div",{className:"".concat(u().join_status_ball," ").concat(u()[y?"ball_joined":"ball_wait"])}),h.userName]}),(0,x.jsxs)("div",{className:"".concat(u().contents," scroll_er"),children:[y||(0,x.jsx)("div",{className:u().wait_tips,children:(0,x.jsx)("span",{className:u().wait_tip_txt,children:"正在链接 ... ..."})}),(0,x.jsx)("div",{children:I.map(function(e){return(0,x.jsx)("div",{children:{tips:(0,x.jsx)("div",{className:u().record_tips,children:(0,x.jsx)("div",{className:u().record_content,children:e.content})}),text:(0,x.jsxs)("div",{className:"".concat(u().record_text," ").concat(e.from.socketId===h.socketId?u().owner:""),children:[(0,x.jsx)("div",{className:u().user_name,children:e.from.userName}),(0,x.jsx)(E,{text:e.content,className:u().user_content})]}),file:(0,x.jsx)("div",{className:u().record_file,children:(0,x.jsx)("div",{className:u().record_content,children:e.content})})}[e.type]},e.id)})})]}),(0,x.jsx)("div",{children:(0,x.jsx)(O,{disabled:!y,style:{height:"unset"},onSubmit:function(e){return P(e.content||"")}})})]})})})}},277:function(e,t,n){"use strict";n.d(t,{K:function(){return c},S:function(){return o}});var r={lazyImg:function(e){return e.replace(/\<img src/g,'<img class="lazy" src="'.concat("https://wsrv.nl/?url=raw.githubusercontent.com/mirrows/photo/main/normal/2023_09_10/pic1694333133502339.gif&w=130&fit=cover&n=-1&q=80",'" data-src'))},tableScroll:function(e){return e.replace(/\<table\>/g,'<div class="scroll_table"><table>').replace(/\<\/table\>/g,"</table></div>")}},c=function(e,t){var n={};null==t||t.forEach(function(e){n[e]=!0});var c=e;return Object.keys(r).forEach(function(e){n[e]||(c=r[e](c))}),c},o=function(e){return e.replace(/\*\*(.+)\*\*(\S)/g,"**$1** $2")}},5083:function(e,t,n){(window.__NEXT_P=window.__NEXT_P||[]).push(["/demos/miniChat",function(){return n(1550)}])},3143:function(e){e.exports={text_area:"MyTextarea_text_area__LOzbr",my_textarea_wrap:"MyTextarea_my_textarea_wrap__aZGa3",operate_wrap:"MyTextarea_operate_wrap__JRo7_",preview:"MyTextarea_preview__JYqBt",submit:"MyTextarea_submit__ykEIz",blog_content:"MyTextarea_blog_content__DkWlw",preview_detail:"MyTextarea_preview_detail__Dp34Q",preview_detail_wrap:"MyTextarea_preview_detail_wrap__fOhia",comment_detail:"MyTextarea_comment_detail__ZyhbX"}},1270:function(e){e.exports={chat_wrap:"miniChat_chat_wrap__FKgzw",join_status_ball:"miniChat_join_status_ball__XssW6",ball_joined:"miniChat_ball_joined__Cv_5R",ball_wait:"miniChat_ball_wait__8y0mc",ballRotate:"miniChat_ballRotate__TCf7_",main_container:"miniChat_main_container__odUrP",contents:"miniChat_contents__6drSv",wait_tips:"miniChat_wait_tips__0dCMA",wait_tip_txt:"miniChat_wait_tip_txt__Eddez",typingWords:"miniChat_typingWords__p2MAi",cursor:"miniChat_cursor__xiLy8",record_tips:"miniChat_record_tips___YOZY",record_text:"miniChat_record_text__PIvzx",user_name:"miniChat_user_name__EpQhz",user_content:"miniChat_user_content__0SI3k",owner:"miniChat_owner__YPrIL"}}},function(e){e.O(0,[880,811,642,922,774,888,179],function(){return e(e.s=5083)}),_N_E=e.O()}]);