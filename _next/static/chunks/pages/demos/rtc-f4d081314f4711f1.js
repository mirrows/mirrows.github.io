(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[826],{1721:function(e,t,n){"use strict";n.r(t),n.d(t,{__N_SSG:function(){return g},default:function(){return h}});var r=n(29),c=n(9499),o=n(7794),a=n.n(o),i=n(7294),u=n(5494),s=n.n(u),l=n(3806),d=n(5835),_=n(7642),f=n(1575),p=n(5893);function v(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function m(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?v(Object(n),!0).forEach(function(t){(0,c.Z)(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):v(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}var g=!0;function h(){var e=(0,i.useState)(0),t=e[0],n=e[1],c=(0,i.useState)(!1),o=c[0],u=c[1],v=(0,i.useState)(!1),g=v[0],h=v[1],w=(0,i.useState)({roomId:"",userName:"",socketId:""}),x=w[0],b=w[1],j=(0,i.useState)({roomId:"",userName:"",socketId:""}),k=j[0],N=j[1],y=(0,i.useRef)({roomId:"",userName:"",socketId:""}),I=(0,i.useRef)(null),O=(0,i.useRef)(null),S=(0,i.useRef)(null),C=(0,i.useRef)(null),P=(0,i.useRef)(null),E=(0,i.useState)(!1),D=E[0],Z=E[1],R=function(){var e=localStorage.info;if(e)try{b(JSON.parse(e));return}catch(t){console.log("fail to parse info",e)}(0,d.oQ)().then(function(e){var t,n,r=(null==e?void 0:null===(t=e.results)||void 0===t?void 0:null===(n=t[0])||void 0===n?void 0:n.name)||"",c={roomId:String(Math.random()).slice(4,8),userName:r?"".concat(r.first," ").concat(r.last):String(Math.random()).slice(4,8),socketId:""};b(c),localStorage.setItem("info",JSON.stringify(c))})},T=function(){var e;if(console.log(x),null===(e=I.current)||void 0===e||e.emit("room_leave",x),null!=S&&S.current){var t,r=null===(t=S.current)||void 0===t?void 0:t.getTracks();null==r||r.forEach(function(e){e.stop()}),S.current=null,C.current&&(C.current.srcObject=null)}O.current=null,P.current&&(P.current.srcObject=null),n(0),Z(!1)},q=function(){var e,t,c,o;I.current=(0,_.io)("wss://use.t-n.top",{transports:["websocket"],withCredentials:!0}),I.current.on("connected",function(e){u(!0),b(function(t){return m(m({},t),{},{socketId:e})})}),I.current.on("room_full",function(){return alert("房间已满，请更换房间号ID")}),I.current.on("room_created",function(e){alert("您已创建并加入【".concat(e.roomId,"】房间")),b(e),n(1)}),I.current.on("room_joined",function(e){var t=e.user,r=e.another;n(2),N(t.socketId!==y.current.socketId?t:r),console.log(t,y.current),t.socketId!==y.current.socketId&&alert("用户".concat(t.userName,"加入【").concat(t.roomId,"】房间"))}),I.current.on("room_leave",function(e){e.socketId!==y.current.socketId?(N({roomId:"",userName:"",socketId:""}),alert("用户".concat(e.userName,"已离开【").concat(e.roomId,"】房间"))):n(0)}),I.current.on("receive_video",function(e){var t;e.socketId!==y.current.socketId&&window.confirm("您要接受用户".concat(e.userName,"的视频电话邀请吗？"))&&(null===(t=I.current)||void 0===t||t.emit("accept_video",y.current))}),I.current.on("accept_video",(e=(0,r.Z)(a().mark(function e(t){var n,r,c,o;return a().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return h(!0),e.next=3,function(){return F.apply(this,arguments)}();case 3:if(function(){var e;O.current||(O.current=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"turn:stun.t-n.top:3478",username:"test12138",credential:"test12138"}]})),O.current.onicecandidate=function(e){var t;return null===(t=I.current)||void 0===t?void 0:t.emit("add_candidate",{candidate:e.candidate,info:y.current})},O.current.oniceconnectionstatechange=function(){var e,t,n,r;(null===(e=O.current)||void 0===e?void 0:e.iceConnectionState)==="connected"&&h(!1),((null===(t=O.current)||void 0===t?void 0:t.iceConnectionState)==="disconnected"||(null===(n=O.current)||void 0===n?void 0:n.iceConnectionState)==="failed")&&(h(!1),alert("连接失败，请重新连接"),T()),console.log("oniceconnectionstatechange: ".concat(null===(r=O.current)||void 0===r?void 0:r.iceConnectionState))},O.current.onsignalingstatechange=function(){var e;console.log("onsignalingstatechange: ".concat(null===(e=O.current)||void 0===e?void 0:e.signalingState))},O.current.ontrack=function(e){return P.current?P.current.srcObject=e.streams[0]:""},O.current.onicegatheringstatechange=function(){var e;console.log("onicegatheringstatechange: ".concat(null===(e=O.current)||void 0===e?void 0:e.iceGatheringState))},null===(e=S.current)||void 0===e||e.getTracks().forEach(function(e){if(S.current){var t;null===(t=O.current)||void 0===t||t.addTrack(e,S.current)}})}(),!(t.socketId!==y.current.socketId)){e.next=11;break}return e.next=7,null===(n=O.current)||void 0===n?void 0:n.createOffer();case 7:return o=e.sent,e.next=10,null===(r=O.current)||void 0===r?void 0:r.setLocalDescription(o);case 10:null===(c=I.current)||void 0===c||c.emit("offer",{offer:o,info:y.current});case 11:case"end":return e.stop()}},e)})),function(t){return e.apply(this,arguments)})),I.current.on("receive_offer",(t=(0,r.Z)(a().mark(function e(t){var n,r,c;return a().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(O.current){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,O.current.setRemoteDescription(t);case 4:return e.next=6,null===(n=O.current)||void 0===n?void 0:n.createAnswer();case 6:return c=e.sent,e.next=9,O.current.setLocalDescription(c);case 9:null===(r=I.current)||void 0===r||r.emit("answer",{answer:c,info:y.current});case 10:case"end":return e.stop()}},e)})),function(e){return t.apply(this,arguments)})),I.current.on("receive_answer",(c=(0,r.Z)(a().mark(function e(t){var n;return a().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,null===(n=O.current)||void 0===n?void 0:n.setRemoteDescription(t);case 2:case"end":return e.stop()}},e)})),function(e){return c.apply(this,arguments)})),I.current.on("add_candidate",(o=(0,r.Z)(a().mark(function e(t){var n;return a().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:null===(n=O.current)||void 0===n||n.addIceCandidate(t);case 1:case"end":return e.stop()}},e)})),function(e){return o.apply(this,arguments)}))};function F(){return(F=(0,r.Z)(a().mark(function e(){return a().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!S.current){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,navigator.mediaDevices.getUserMedia({video:!f.tq||{facingMode:"user"},audio:!0}).catch(function(e){console.log("error happen: ".concat(e.name))});case 4:if(e.t0=e.sent,e.t0){e.next=7;break}e.t0=null;case 7:S.current=e.t0,S&&(Z(!0),C.current&&S.current&&(C.current.srcObject=S.current));case 9:case"end":return e.stop()}},e)}))).apply(this,arguments)}return(0,i.useEffect)(function(){return R(),q(),function(){var e,t;T(),null===(e=I.current)||void 0===e||e.disconnect(),null===(t=I.current)||void 0===t||t.off()}},[]),(0,i.useEffect)(function(){y.current=x},[x]),(0,p.jsxs)(p.Fragment,{children:[!t&&(0,p.jsx)("div",{className:s().line_banner,children:"移动端请使用谷歌浏览器体验完整功能!!!"}),t?(0,p.jsxs)("div",{className:s().total_wrap,children:[(0,p.jsxs)("div",{className:s().local_wrap,children:[(0,p.jsx)("video",{ref:C,className:s().local_video,autoPlay:!0}),1===t&&(0,p.jsxs)("div",{className:s().local_tips,children:[(0,p.jsx)("div",{style:{marginBottom:"8px"},children:(0,p.jsx)(l.Z,{type:"loading_2",className:s().loading_icon})}),"正在等待对方进入..."]}),(0,p.jsx)("div",{style:{color:"#fff"},children:k.userName})]}),(0,p.jsx)("video",{ref:P,className:s().target_video,autoPlay:!0}),(0,p.jsxs)("div",{className:s().operate_wrap,children:[D||(0,p.jsx)("button",{className:"".concat(s().chat_btn," ").concat(s().back_btn),onClick:T,children:(0,p.jsx)(l.Z,{type:"back_2",style:{width:"2rem"}})}),(0,p.jsxs)("div",{className:s().room_msg,children:[g&&(0,p.jsx)("div",{children:"正在获取视频数据..."}),(0,p.jsx)("div",{children:x.userName}),(0,p.jsxs)("div",{children:["房间号: ",x.roomId]})]}),(0,p.jsx)("button",{disabled:2!==t&&!D,className:s().chat_btn,style:{backgroundColor:D?"red":"green"},onClick:D?T:function(){var e;null===(e=I.current)||void 0===e||e.emit("request_video",x)},children:(0,p.jsx)(l.Z,{type:"chat_1",style:{width:"2rem",fill:"#FFF"}})})]})]}):(0,p.jsxs)("div",{className:s().input_wrap,children:[(0,p.jsxs)("div",{className:s().img_wrap,children:[(0,p.jsx)("img",{style:{width:"200px",margin:"10vh 0"},src:"https://wsrv.nl/?url=raw.githubusercontent.com/mirrows/photo/main/normal/2024_10_14/pic1728899129621292.png&n=-1&q=80",alt:""}),o?"":(0,p.jsxs)("div",{className:s().loading_tips,children:[(0,p.jsx)(l.Z,{type:"loading_2",className:s().loading_icon}),"正在连接服务器..."]})]}),(0,p.jsx)("input",{type:"text",placeholder:"请输入房间号",className:s().input,defaultValue:x.roomId,onInput:function(e){return b(function(t){return m(m({},t),{},{roomId:e.target.value})})}}),(0,p.jsx)("input",{type:"text",placeholder:"请输入用户名",className:s().input,defaultValue:x.userName,onInput:function(e){return b(function(t){return m(m({},t),{},{userName:e.target.value})})}}),(0,p.jsx)("button",{className:"normal_btn",disabled:!o,onClick:function(){var e;x.roomId&&x.userName&&(localStorage.setItem("info",JSON.stringify(x)),null===(e=I.current)||void 0===e||e.emit("create_or_join_room",x))},children:"创建/加入房间"})]})]})}},528:function(e,t,n){(window.__NEXT_P=window.__NEXT_P||[]).push(["/demos/rtc",function(){return n(1721)}])},5494:function(e){e.exports={total_wrap:"rtc_total_wrap__mB_oN",img_wrap:"rtc_img_wrap__rWeS9",loading_tips:"rtc_loading_tips__fOgOz",loading_icon:"rtc_loading_icon__wfOHr",rotate:"rtc_rotate____jNs",input_wrap:"rtc_input_wrap__mExP5",input:"rtc_input__Lq1z2",local_wrap:"rtc_local_wrap__E9d6i",local_tips:"rtc_local_tips__8t67H",local_video:"rtc_local_video__6WAdj",target_video:"rtc_target_video__DTIyo",operate_wrap:"rtc_operate_wrap__sIOsu",room_msg:"rtc_room_msg__u5elS",chat_btn:"rtc_chat_btn__zByt7",back_btn:"rtc_back_btn__qoTkF",line_banner:"rtc_line_banner__Byl2n"}}},function(e){e.O(0,[642,774,888,179],function(){return e(e.s=528)}),_N_E=e.O()}]);