(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[826],{1721:function(e,n,t){"use strict";t.r(n),t.d(n,{__N_SSG:function(){return g},default:function(){return h}});var r=t(29),o=t(9499),c=t(7794),u=t.n(c),a=t(7294),i=t(5494),s=t.n(i),l=t(3806),d=t(5835),f=t(7642),v=t(1575),p=t(5893);function _(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),t.push.apply(t,r)}return t}function m(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?_(Object(t),!0).forEach(function(n){(0,o.Z)(e,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):_(Object(t)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})}return e}var g=!0;function h(){var e=(0,a.useState)(!1),n=e[0],t=e[1],o=(0,a.useState)(!1),c=o[0],i=o[1],_=(0,a.useState)({roomId:"",userName:"",socketId:""}),g=_[0],h=_[1],w=(0,a.useRef)({roomId:"",userName:"",socketId:""}),x=(0,a.useRef)(null),b=(0,a.useRef)(null),k=(0,a.useRef)(null),j=(0,a.useRef)(null),y=(0,a.useRef)(null);(0,a.useRef)(null),(0,a.useRef)();var I=(0,a.useState)(!1),N=I[0],O=I[1],S=function(){var e=localStorage.info;if(e)try{h(JSON.parse(e));return}catch(n){console.log("fail to parse info",e)}(0,d.oQ)().then(function(e){console.log(e);var n,t,r=(null==e?void 0:null===(n=e.results)||void 0===n?void 0:null===(t=n[0])||void 0===t?void 0:t.name)||"",o={roomId:String(Math.random()).slice(4,8),userName:r?"".concat(r.first," ").concat(r.last):String(Math.random()).slice(4,8),socketId:""};h(o),localStorage.setItem("info",JSON.stringify(o))})};function P(){if(k){var e,n,r=null===(e=k.current)||void 0===e?void 0:e.getTracks();null==r||r.forEach(function(e){e.stop()}),b.current=null,t(!1),O(!1),null===(n=x.current)||void 0===n||n.emit("room_leave",g)}}var E=function(){var e,n,o,c;console.log(5677),x.current=(0,f.io)("wss://use.t-n.top",{transports:["websocket"],withCredentials:!0}),x.current.on("connected",function(e){console.log(7888,e),i(!0),h(function(n){return m(m({},n),{},{socketId:e})})}),x.current.on("room_full",function(){return alert("房间已满，请更换房间号ID")}),x.current.on("room_created",function(e){alert("您已创建并加入【".concat(e.roomId,"】房间")),h(e),t(!0)}),x.current.on("room_joined",function(e){t(!0),console.log(e,w.current),e.socketId!==w.current.socketId&&alert("用户".concat(e.userName,"加入【").concat(e.roomId,"】房间"))}),x.current.on("room_leave",function(e){e.socketId!==w.current.socketId?alert("用户".concat(e.userName,"已离开【").concat(e.roomId,"】房间")):t(!1)}),x.current.on("receive_video",function(e){var n;e.socketId!==w.current.socketId&&window.confirm("您要接受用户".concat(e.userName,"的视频电话邀请吗？"))&&(null===(n=x.current)||void 0===n||n.emit("accept_video",w.current))}),x.current.on("accept_video",(e=(0,r.Z)(u().mark(function e(n){var t,r,o,c;return u().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,function(){return D.apply(this,arguments)}();case 2:if(function(){var e;b.current||(b.current=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"turn:stun.t-n.top:3478",username:"test12138",credential:"test12138"}]})),b.current.onicecandidate=function(e){var n;return null===(n=x.current)||void 0===n?void 0:n.emit("add_candidate",{candidate:e.candidate,info:w.current})},b.current.oniceconnectionstatechange=function(){var e;console.log("oniceconnectionstatechange: ".concat(null===(e=b.current)||void 0===e?void 0:e.iceConnectionState))},b.current.onsignalingstatechange=function(){var e;console.log("onsignalingstatechange: ".concat(null===(e=b.current)||void 0===e?void 0:e.signalingState))},b.current.ontrack=function(e){return y.current?y.current.srcObject=e.streams[0]:""},b.current.onicegatheringstatechange=function(){var e;console.log("onicegatheringstatechange: ".concat(null===(e=b.current)||void 0===e?void 0:e.iceGatheringState))},null===(e=k.current)||void 0===e||e.getTracks().forEach(function(e){if(k.current){var n;null===(n=b.current)||void 0===n||n.addTrack(e,k.current)}})}(),!(n.socketId!==w.current.socketId)){e.next=10;break}return e.next=6,null===(t=b.current)||void 0===t?void 0:t.createOffer();case 6:return c=e.sent,e.next=9,null===(r=b.current)||void 0===r?void 0:r.setLocalDescription(c);case 9:null===(o=x.current)||void 0===o||o.emit("offer",{offer:c,info:w.current});case 10:case"end":return e.stop()}},e)})),function(n){return e.apply(this,arguments)})),x.current.on("receive_offer",(n=(0,r.Z)(u().mark(function e(n){var t,r,o;return u().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(b.current){e.next=2;break}return e.abrupt("return");case 2:return console.log(34343),e.next=5,b.current.setRemoteDescription(n);case 5:return e.next=7,null===(t=b.current)||void 0===t?void 0:t.createAnswer();case 7:return o=e.sent,e.next=10,b.current.setLocalDescription(o);case 10:null===(r=x.current)||void 0===r||r.emit("answer",{answer:o,info:w.current});case 11:case"end":return e.stop()}},e)})),function(e){return n.apply(this,arguments)})),x.current.on("receive_answer",(o=(0,r.Z)(u().mark(function e(n){var t;return u().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("receive_answer",5555555),e.next=3,null===(t=b.current)||void 0===t?void 0:t.setRemoteDescription(n);case 3:case"end":return e.stop()}},e)})),function(e){return o.apply(this,arguments)})),x.current.on("add_candidate",(c=(0,r.Z)(u().mark(function e(n){var t;return u().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:console.log("add_candidate",5555555),null===(t=b.current)||void 0===t||t.addIceCandidate(n);case 2:case"end":return e.stop()}},e)})),function(e){return c.apply(this,arguments)}))};function D(){return(D=(0,r.Z)(u().mark(function e(){return u().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!k.current){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,navigator.mediaDevices.getUserMedia({video:!v.tq||{facingMode:"user"},audio:!1}).catch(function(e){console.log("error happen: ".concat(e.name))});case 4:if(e.t0=e.sent,e.t0){e.next=7;break}e.t0=null;case 7:k.current=e.t0,k&&(O(!0),j.current&&k.current&&(j.current.srcObject=k.current));case 9:case"end":return e.stop()}},e)}))).apply(this,arguments)}return(0,a.useEffect)(function(){return S(),E(),function(){var e,n;P(),null===(e=x.current)||void 0===e||e.disconnect(),null===(n=x.current)||void 0===n||n.off()}},[]),(0,a.useEffect)(function(){w.current=g},[g]),(0,p.jsx)(p.Fragment,{children:n?(0,p.jsxs)("div",{className:s().total_wrap,children:[(0,p.jsx)("video",{ref:j,className:s().local_video,autoPlay:!0}),(0,p.jsx)("video",{ref:y,className:s().target_video,autoPlay:!0}),(0,p.jsxs)("div",{className:s().operate_wrap,children:[(0,p.jsx)("div",{className:s().room_msg,children:(0,p.jsxs)("div",{children:["房间号: ",g.roomId]})}),(0,p.jsx)("button",{className:s().chat_btn,style:{backgroundColor:N?"red":"green"},onClick:N?P:function(){var e;null===(e=x.current)||void 0===e||e.emit("request_video",g)},children:(0,p.jsx)(l.Z,{type:"chat_1",style:{width:"2rem",fill:"#FFF"}})})]})]}):(0,p.jsxs)("div",{className:s().input_wrap,children:[(0,p.jsx)("div",{children:(0,p.jsx)("img",{style:{width:"200px",margin:"10vh 0"},src:"https://wsrv.nl/?url=raw.githubusercontent.com/mirrows/photo/main/normal/2024_10_14/pic1728899129621292.png&n=-1&q=80",alt:""})}),(0,p.jsx)("input",{type:"text",placeholder:"请输入房间号",className:s().input,defaultValue:g.roomId,onInput:function(e){return h(function(n){return m(m({},n),{},{roomId:e.target.value})})}}),(0,p.jsx)("input",{type:"text",placeholder:"请输入用户名",className:s().input,defaultValue:g.userName,onInput:function(e){return h(function(n){return m(m({},n),{},{userName:e.target.value})})}}),(0,p.jsx)("button",{className:"normal_btn",disabled:!c,onClick:function(){var e;g.roomId&&g.userName&&(console.log(7777,g,x.current),localStorage.setItem("info",JSON.stringify(g)),null===(e=x.current)||void 0===e||e.emit("create_or_join_room",g))},children:"创建/加入房间"})]})})}},528:function(e,n,t){(window.__NEXT_P=window.__NEXT_P||[]).push(["/demos/rtc",function(){return t(1721)}])},5494:function(e){e.exports={total_wrap:"rtc_total_wrap__mB_oN",input_wrap:"rtc_input_wrap__mExP5",input:"rtc_input__Lq1z2",local_video:"rtc_local_video__6WAdj",target_video:"rtc_target_video__DTIyo",operate_wrap:"rtc_operate_wrap__sIOsu",room_msg:"rtc_room_msg__u5elS",chat_btn:"rtc_chat_btn__zByt7"}}},function(e){e.O(0,[642,774,888,179],function(){return e(e.s=528)}),_N_E=e.O()}]);